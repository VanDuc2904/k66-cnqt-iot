<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate="title">TLD66 - Technology Leading to Discovery</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="CSS.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha384-gZ3mC7EJGpe4g0fH26mk2raVScTR3+/wD8/wJkcnExZZwodkL1Xb0xnL0IisveU0" crossorigin=""/>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha384-uUlWqr9qU6wI1e2jGncvBa/pft3o9tPvzL+nTBGOZTLuwO7lUp2VkGH5NZUJc9Ix" crossorigin=""></script>
</head>
<body>
          <div id="notificationText" class="bg-success text-white text-center p-2">
        Đang tải thông báo....
        <button type="button" class="btn-close btn-close-white" aria-label="Close" onclick="dismissNotification()"></button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.2.10/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.10/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.10/firebase-analytics.js"></script>

    <script>
        var firebaseConfig = {
            apiKey: "AIzaSyC3EhCzgXR02e_gjvJqEb32htKMqo3mXug",
            authDomain: "tld66-3d929.firebaseapp.com",
            databaseURL: "https://tld66-3d929-default-rtdb.firebaseio.com/",
            projectId: "tld66-3d929",
            storageBucket: "tld66-3d929.appspot.com",
            messagingSenderId: "580068871289",
            appId: "1:580068871289:web:d46a8e49eee792a6d518a8",
            measurementId: "G-3R2JXXFMD0"
        };
        firebase.initializeApp(firebaseConfig);
        firebase.analytics();

        var notificationText = document.getElementById('notificationText');
        var dbRef = firebase.database().ref().child('notification/content');
        dbRef.on('value', snap => {
            if (snap.exists()) {
                notificationText.innerText = snap.val();
            } else {
                notificationText.innerText = "Không có thông báo nào được tìm thấy.";
            }
            setTimeout(dismissNotification, 45000);
        }, error => {
            console.error('Lỗi tải thông báo:', error);
            notificationText.innerText = "Lỗi tải thông báo.";
            setTimeout(dismissNotification, 45000);
        });
        function dismissNotification() {
            notificationText.style.display = 'none';
        }
    </script>
    <script>
        const translations = {
            vi: {
                title: "TLD66 - Technology Leading to Discovery",
                notification: "Phiên bản cập nhật ngày 22/08/2024. Sẽ có những nâng cấp trong thời gian tới.",
                home: "Trang chủ",
                realtimeData: "Thông số thời gian thực",
                dataStatistics: "Dữ liệu & thống kê",
                feedback: "Góp ý & nhận xét",
                login: "Đăng nhập",
                signup: "Đăng ký nhận thông tin qua email",
                aboutHeader: "Cảm biến nhiệt độ & độ ẩm",
                contactInfo: "Thông tin hỗ trợ",
                phone: "Số điện thoại",
                email: "Email",
                language: "Ngôn ngữ",
                mapTitle: "Bản đồ giám sát chất lượng không khí",
                latestDataTitle: "THÔNG TIN DỮ LIỆU MỚI NHẤT",
                pollutionLevelsTitle: "Các cấp độ ô nhiễm không khí",
                pollutionAmount: "Hàm lượng",
                pollutionLevel: "Cấp độ",
                pollutionQuality: "Chất lượng không khí",
                qualityGood: "Tốt",
                qualityModerate: "Vừa phải",
                qualityUnhealthy: "Kém",
                qualityVeryUnhealthy: "Rất kém",
                dataSectionTitle: "Dữ liệu quan trắc chất lượng không khí",
                dataSectionSubtitle: "Dữ liệu được cập nhật từ thiết bị TLD66",
                chartSectionTitle: "Biểu đồ giám sát chất lượng không khí",
                webUsageGuideTitle: "Tài liệu sử dụng web",
                codeDocumentTitle: "Tài liệu mã code",
                researchTitle: "Nghiên cứu",
                teamSectionTitle: "Nhóm nghiên cứu gồm:",
                teamMembersSubtitle: "Các thành viên chính",
                member1Name: "Thái Văn Đức",
                member2Name: "Nguyễn Khánh Linh",
                member3Name: "Giang Ngọc Thảo",
                coSensorHeader: "Cảm biến hàm lượng khí CO",
                airQualitySensorHeader: "Cảm biến đo chất lượng khí",
                fineDustSensorHeader: "Cảm biến đo hàm lượng bụi mịn",
                environmentInfoTitle: "Thông tin chất lượng môi trường không khí",
                dht22Description: "Cảm biến độ ẩm và nhiệt độ DHT22 sử dụng giao tiếp 1 Wire dễ dàng kết nối với Vi điều khiển để thực hiện các ứng dụng đo nhiệt độ, độ ẩm môi trường, cảm biến có chất lượng tốt, kích thước nhỏ gọn, độ bền và độ ổn định cao.",
                dht22LinkText: "xem chi tiết tại đây",
                coSensorDescription: "Cảm biến khí CO MQ-7 là cảm biến bán dẫn giá rẻ có khả năng phát hiện khí carbon monoxide từ 10 đến 1000 ppm. Vật liệu tạo ra cảm biến là từ SnO2, có độ dẫn điện thấp trong không khí sạch.",
                coSensorLinkText: "xem chi tiết tại đây",
                sds011Description: "SDS011 là cảm biến đo chất lượng không khí có thể phát hiện các hạt bụi và nồng độ khói trong không khí. Nó có thể đo nồng độ các hạt bụi có kích thước từ 0.3 đến 10um.",
                sds011LinkText: "xem chi tiết tại đây",
                sharpDustSensorDescription: "Cảm biến dùng để nhận biết nồng độ bụi trong không khí. Nguyên lý hoạt động dựa trên led phát hồng ngoại trong cảm biến, khi có bụi vào sẽ bị khúc xạ, làm giảm cường độ tia hồng ngoại dẫn đến điện áp thay đổi.",
                sharpDustSensorLinkText: "xem chi tiết tại đây",
                "signup": "Đăng ký nhận thông tin qua email",
                "emailAddress": "Địa chỉ Email",
                "fullName": "Họ và tên",
                "phoneNumber": "Số điện thoại",
                "useData": "Bạn có muốn sử dụng dữ liệu?",
                "yes": "Có",
                "no": "Không",
                "usagePurpose": "Mục đích sử dụng",
                "signup1": "Đăng nhập & Đăng kí",
                "signup": "Đăng ký",
                "password": "Mật khẩu",
                "passwordPlaceholder": "Nhập mật khẩu",
                 note: "Chú ý: Dữ liệu dựa trên sản phẩm thử nghiệm TLD 66 của nhóm sinh viên Khoa Địa Chất, Trường ĐH KHTN - ĐHQG HN KHÔNG THAY THẾ CHO CÁC THÔNG SỐ CHÍNH THỨC CỦA CƠ QUAN NHÀ NƯỚC VỀ ĐÁNH GIÁ CHẤT LƯỢNG KHÔNG KHÍ"
            },
            en: {
                title: "TLD66 - Technology Leading to Discovery",
                notification: "Version updated on 22/08/2024. More upgrades will come soon.",
                home: "Home",
                realtimeData: "Real-time Data",
                dataStatistics: "Data & Statistics",
                feedback: "Feedback",
                login: "Login",
                signup: "Sign up for updates via email",
                aboutHeader: "Temperature & Humidity Sensor",
                contactInfo: "Support Information",
                phone: "Phone",
                email: "Email",
                language: "Language",
                mapTitle: "Air Quality Monitoring Map",
                latestDataTitle: "LATEST DATA INFORMATION",
                pollutionLevelsTitle: "Air Pollution Levels",
                pollutionAmount: "Amount",
                pollutionLevel: "Level",
                pollutionQuality: "Air Quality",
                qualityGood: "Good",
                qualityModerate: "Moderate",
                qualityUnhealthy: "Unhealthy",
                qualityVeryUnhealthy: "Very Unhealthy",
                dataSectionTitle: "Air Quality Monitoring Data",
                dataSectionSubtitle: "Data updated from TLD66 device",
                chartSectionTitle: "Air Quality Monitoring Chart",
                webUsageGuideTitle: "Web Usage Guide",
                codeDocumentTitle: "Code Document",
                researchTitle: "Research",
                teamSectionTitle: "Research Team Includes:",
                teamMembersSubtitle: "Main members",
                member1Name: "Thái Văn Đức",
                member2Name: "Nguyễn Khánh Linh",
                member3Name: "Giang Ngọc Thảo",
                coSensorHeader: "CO Gas Sensor",
                airQualitySensorHeader: "Air Quality Sensor",
                fineDustSensorHeader: "Fine Dust Sensor",
                environmentInfoTitle: "Air Quality Monitoring Information",
                dht22Description: "The DHT22 Temperature Humidity Sensor uses 1-Wire communication, making it easy to connect and communicate with microcontrollers for temperature and humidity measurement applications. The sensor has good quality, compact size, high durability, and stability.",
                dht22LinkText: "see details here",
                coSensorDescription: "The CO MQ-7 sensor is a low-cost semiconductor sensor capable of detecting carbon monoxide with concentrations ranging from 10 to 1000 ppm. The sensor material is made of SnO2, which has low conductivity in clean air.",
                coSensorLinkText: "see details here",
                sds011Description: "The SDS011 is an air quality sensor that can be used to detect dust particles and smoke concentration in the air. More precisely, it can measure the concentration of particulate matter (PM) in the air. It can detect particle concentrations ranging from 0.3 to 10um.",
                sds011LinkText: "see details here",
                sharpDustSensorDescription: "The sensor is used to detect dust concentration in the air. The working principle is based on an infrared LED emitted within the sensor. When dust enters, it scatters the light, reducing the intensity of the infrared beam, which leads to a change in voltage.",
                sharpDustSensorLinkText: "see details here",
                "signup": "Sign up for updates via email",
                "emailAddress": "Email Address",
                "fullName": "Full Name",
                "phoneNumber": "Phone Number",
                "useData": "Would you like to use data?",
                "yes": "Yes",
                "no": "No",
                "usagePurpose": "Usage Purpose",
                "signup1": "Login & sign",
                "signup": "Sign up for updates via email",
                 "password": "Password",
                 "passwordPlaceholder": "Enter your password",
                 note: "Note: The data is based on the experimental product TLD 66 by students of the Geology Department, University of Science, VNU HN, and DOES NOT REPLACE OFFICIAL PARAMETERS FROM STATE AGENCIES FOR AIR QUALITY ASSESSMENT."
            }
        };

        function setLanguage(language) {
            localStorage.setItem('language', language);
            updateContent(language);
        }

        function updateContent(language) {
            document.querySelectorAll("[data-translate]").forEach(element => {
                const key = element.getAttribute("data-translate");
                element.textContent = translations[language][key] || element.textContent;
            });
        }

        document.addEventListener("DOMContentLoaded", () => {
            const language = localStorage.getItem('language') || 'vi';
            updateContent(language);
        });
    </script>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <a class="navbar-brand" href="#">
                <img src="img/Logo1.png" alt="" style="height: 150px;">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="languageDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" data-translate="language">
                        Ngôn ngữ
                    </a>
                    <ul class="dropdown-menu" aria-labelledby="languageDropdown">
                        <li><a class="dropdown-item" href="#" onclick="setLanguage('vi')">Tiếng Việt</a></li>
                        <li><a class="dropdown-item" href="#" onclick="setLanguage('en')">English</a></li>
                    </ul>
                    <script>
                        document.getElementById('vi').addEventListener('click', function () {
                            localStorage.setItem('language', 'vi');
                            window.location.href = 'data.html'; 
                        });
                
                        document.getElementById('en').addEventListener('click', function () {
                            localStorage.setItem('language', 'en');
                            window.location.href = 'data.html'; 
                        });
                
                        document.addEventListener('DOMContentLoaded', async function() {
                            const notificationBar = document.getElementById('notificationBar');
                                try {
                                    const response = await fetch('/api/notification');
                                    const data = await response.json();
                                    notificationBar.innerHTML = `
                                        ${data.notification}
                                        <button type="button" class="btn-close btn-close-white" aria-label="Close" onclick="dismissNotification()" style="float: right; margin-right: 20px;"></button>
                                    `;
                                } catch (error) {
                                    console.error('Error fetching notification:', error);
                                }
                            });

                            function dismissNotification() {
                                document.getElementById('notificationBar').style.display = 'none';
                            }
                        
                    </script>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-translate="home">Trang chủ</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="realtimeDataLink" href="#" onclick="handleLinkClick(event)" data-translate="realtimeData">Chức năng cho admin</a>
                </li>
                
                <script>
                    let isCommandUnlocked = false;
                    function updateCommandStatus(isUnlocked) {
                        isCommandUnlocked = isUnlocked;
                        const linkElement = document.getElementById('realtimeDataLink');
                
                        if (isUnlocked) {
                            console.log('Chức năng đã được mở khóa.');
                            linkElement.href = "https://script.google.com/macros/s/AKfycbxypKpWoIb8oYujhzz9yjtdHaxOdScEKFOadjERMfmb0qqOBdFaAPKgzEnnAkgSL9c1/exec";
                        } else {
                            console.log('Chức năng đã bị khóa.');
                            linkElement.href = "#"; 
                        }
                    }
                    document.addEventListener('DOMContentLoaded', () => {
                        firebase.database().ref('commandSettings').once('value')
                            .then(snapshot => {
                                const commandSettings = snapshot.val();
                                if (commandSettings && commandSettings.isUnlocked !== undefined) {
                                    updateCommandStatus(commandSettings.isUnlocked);
                                }
                            })
                            .catch(error => {
                                console.error('Lỗi tải trạng thái:', error);
                            });
                    });
                    function handleLinkClick(event) {
                        if (!isCommandUnlocked) {
                            event.preventDefault(); 
                            alert('Hiện tại admin đã khóa quyền truy cập chức năng này.');
                        }
                    }
                </script>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="handleDataStatisticsClick()" data-translate="dataStatistics">Dữ liệu & thống kê</a>
                </li>
                <script>
                    let isAccessUnlocked = false;
                    function updateAccessControl(isUnlocked) {
                        isAccessUnlocked = isUnlocked;
                    }
                    document.addEventListener('DOMContentLoaded', () => {
                        firebase.database().ref('accessControl/dataStatistics').once('value')
                            .then(snapshot => {
                                const accessControl = snapshot.val();
                                if (accessControl && accessControl.isUnlocked !== undefined) {
                                    updateAccessControl(accessControl.isUnlocked);
                                }
                            })
                            .catch(error => {
                                console.error('Lỗi tải trạng thái truy cập:', error);
                            });
                    });

                    function handleDataStatisticsClick() {
                        if (isAccessUnlocked) {
                            alert("Hiện tại admin đã mở khóa chức năng này");
                            window.location.href = 'results.htm';
                        } else {
                            alert("Vui lòng đăng nhập");
                            window.location.href = 'dktk.htm';
                        }
                    }
                </script>
                </li>                
                <li class="nav-item">
                    <a class="nav-link" href="https://docs.google.com/forms/d/e/1FAIpQLSe0Zrll8kyemYWhAIPpTdnKahBHg-eKu1UOXxXvGQqIxun0aQ/viewform" target="_blank" data-translate="feedback">Góp ý & nhận xét</a>
                </li>
                <li class="nav-item">
                    <a id="showFormButton" class="nav-link" href="dktk.htm" data-translate="signup1">Đăng nhập & đăng kí</a>
                </li>               
            </ul>
        </div>
    </nav>
    <section id="map-section" class="map-section-padding">
        <div class="row">
            <div class="col-lg-6">
                <div id="data-container" class="mb-4">
                </div>
            </div>
        <div class="col-lg-6">
            <div id="map" style="height: 320px;"></div>
        </div>
    </div>
    </section>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyANCLP-LOwPUPr0HpeBGWxl4ZfoRXVgdzY&callback=initMap" async defer></script>
        <script>
        let map, marker, infowindow, environmentChart;
        document.addEventListener('DOMContentLoaded', function () {
            firebase.database().ref('mapSettings').on('value', function(snapshot) {
                const mapSettings = snapshot.val();
                if (mapSettings) {
                    localStorage.setItem('mapLat', mapSettings.lat);
                    localStorage.setItem('mapLng', mapSettings.lng);
                    localStorage.setItem('mapTitle', mapSettings.title);
        
                    updateMarkerPosition(mapSettings.lat, mapSettings.lng, mapSettings.title);
                }
            });
            initMap();
        });

        function initMap() {
            const lat = parseFloat(localStorage.getItem('mapLat')) || 21.058941;
            const lng = parseFloat(localStorage.getItem('mapLng')) || 105.535798;
            const title = localStorage.getItem('mapTitle') || 'Nhà Khách KTX ĐHQG Hòa Lạc';
        
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 13,
                center: { lat: lat, lng: lng }
            });
        
            // Sử dụng icon mặc định ban đầu, sẽ được cập nhật sau
            marker = new google.maps.Marker({
                position: { lat: lat, lng: lng },
                map: map,
                title: title,
                icon: 'img/md.png' // Icon mặc định
            });
        
            infowindow = new google.maps.InfoWindow({
                content: `<h3>${title}</h3><p>Đang tải dữ liệu...</p>`
            });
        
            marker.addListener('click', function() {
                infowindow.open(map, marker);
            });
        
            fetchData().then(() => {
                const lastRow = json.values[json.values.length - 1];
                const md = {
                    date: lastRow[0] ? new Date(lastRow[0]).toLocaleDateString('vi-VN') : 'Không có dữ liệu',
                    time: lastRow[0] ? new Date(lastRow[0]).toLocaleTimeString('vi-VN') : 'Không có dữ liệu',
                    temperature: lastRow[1] || 0,
                    humidity: lastRow[2] || 0,
                    co: lastRow[3] || 0,
                    pm25: lastRow[4] || 0,
                    pm10: lastRow[5] || 0,
                    co2: lastRow[6] || 0
                };
                updateMapInfoWindow(md);
            });
        
            setInterval(() => {
                fetchData().then(() => {
                    const lastRow = json.values[json.values.length - 1];
                    const md = {
                        date: lastRow[0] ? new Date(lastRow[0]).toLocaleDateString('vi-VN') : 'Không có dữ liệu',
                        time: lastRow[0] ? new Date(lastRow[0]).toLocaleTimeString('vi-VN') : 'Không có dữ liệu',
                        temperature: lastRow[1] || 0,
                        humidity: lastRow[2] || 0,
                        co: lastRow[3] || 0,
                        pm25: lastRow[4] || 0,
                        pm10: lastRow[5] || 0,
                        co2: lastRow[6] || 0
                    };
                    updateMapInfoWindow(md);
        });
    }, 30000);
}
        function updateMarkerPosition(lat, lng, title) {
            const position = {lat: parseFloat(lat), lng: parseFloat(lng)};
            marker.setPosition(position);
            map.setCenter(position);
            marker.setTitle(title);
        
            infowindow.setContent(`<h3>${title}</h3>`);
        
            marker.addListener('click', function() {
                infowindow.open(map, marker);
            });
        }
        let isClickListenerAdded = false;

        function updateMarkerPosition(lat, lng, title) {
            const position = {lat: parseFloat(lat), lng: parseFloat(lng)};
            marker.setPosition(position);
            map.setCenter(position);
            marker.setTitle(title);
            infowindow.setContent(`<h3>${title}</h3>`);
            if (!isClickListenerAdded) {
                marker.addListener('click', function() {
                    infowindow.open(map, marker);
                });
                isClickListenerAdded = true;
            }
        }
        function updateInfoWindow() {
            const latestData = getLatestDataFromDOM();

            const contentString = `
                <h3>Nhà Khách KTX ĐHQG Hòa Lạc</h3>
                <p data-translate="date">Ngày: ${latestData.date}</p>
                <p data-translate="time">Giờ: ${latestData.time}</p>
                <p data-translate="temperature">Nhiệt độ: ${latestData.temperature} °C</p>
                <p data-translate="humidity">Độ ẩm: ${latestData.humidity} %</p>
                <p data-translate="co">CO: ${latestData.co} ppm</p>
                <p data-translate="pm25">PM2.5: ${latestData.pm25} µg/m³</p>
            `;

            infowindow.setContent(contentString);
            marker.setIcon(getMarkerIcon(latestData.pm25));
            infowindow.open(map, marker);
        }
        function getLatestDataFromDOM() {
            const date = document.getElementById('latestDate') ? document.getElementById('latestDate').textContent : 'Không có dữ liệu';
            const time = document.getElementById('latestTime') ? document.getElementById('latestTime').textContent : 'Không có dữ liệu';
            const temperature = document.getElementById('latestTemperature') ? parseFloat(document.getElementById('latestTemperature').textContent) : 0;
            const humidity = document.getElementById('latestHumidity') ? parseFloat(document.getElementById('latestHumidity').textContent) : 0;
            const co = document.getElementById('latestCO') ? parseFloat(document.getElementById('latestCO').textContent) : 0;
            const pm25 = document.getElementById('latestPM25') ? parseFloat(document.getElementById('latestPM25').textContent) : 0;

            return { date, time, temperature, humidity, co, pm25 };
        }
        function displayData(data) {
          // 1. Parse timestamp thành ngày & giờ
          const ts = data[0] || '';
          let dateStr = 'Không có dữ liệu', timeStr = 'Không có dữ liệu';
          if (ts) {
            const d = new Date(ts);
            if (!isNaN(d)) {
              dateStr = d.toLocaleDateString('vi-VN');
              timeStr = d.toLocaleTimeString('vi-VN');
            }
          }
        
          // 2. Lấy các chỉ số theo đúng index
          const temperature = data[1] ?? 'Không có dữ liệu';
          const humidity    = data[2] ?? 'Không có dữ liệu';
          const co          = data[3] ?? 'Không có dữ liệu';
          const pm25        = data[4] ?? 'Không có dữ liệu';
          const pm10        = data[5] ?? 'Không có dữ liệu';
          const co2         = data[6] ?? 'Không có dữ liệu';
        
          // 3. Cập nhật HTML
          const container = document.getElementById('data-container');
          container.innerHTML = `
            <div class="card mb-4">
              <div class="card-body">
                <h5 class="card-title" data-translate="environmentInfoTitle">Dữ liệu thời gian thực</h5>
                <p class="card-text" style="font-size:14px;font-style:italic;">
                  Dữ liệu được cập nhật mỗi 5 phút 1 lần
                </p>
                <p class="card-text" data-translate="date"><strong>Ngày:</strong> ${dateStr}</p>
                <p class="card-text" data-translate="time"><strong>Giờ:</strong> ${timeStr}</p>
                <p class="card-text" data-translate="temperature"><strong>Nhiệt độ:</strong> ${temperature} °C</p>
                <p class="card-text" data-translate="humidity"><strong>Độ ẩm:</strong> ${humidity} %</p>
                <p class="card-text" data-translate="co"><strong>CO:</strong> ${co} ppm</p>
                <p class="card-text" data-translate="pm25"><strong>PM2.5:</strong> ${pm25} µg/m³</p>
                <p class="card-text"><strong>PM10:</strong> ${pm10} µg/m³</p>
                <p class="card-text"><strong>CO₂:</strong> ${co2} ppm</p>
              </div>
            </div>
          `;
        }

        
        function updateInfoWindow(latestData) {
            const contentString = `
                <h3>Nhà Khách KTX ĐHQG Hòa Lạc</h3>
                <p data-translate="date">Ngày: ${latestData.date}</p>
                <p data-translate="time">Giờ: ${latestData.time}</p>
                <p data-translate="temperature">Nhiệt độ: ${latestData.temperature} °C</p>
                <p data-translate="humidity">Độ ẩm: ${latestData.humidity} %</p>
                <p data-translate="co">CO: ${latestData.co} ppm</p>
                <p data-translate="pm25">PM2.5: ${latestData.pm25} µg/m³</p>
            `;
        
            infowindow.setContent(contentString);
            marker.setIcon(getMarkerIcon(latestData.pm25));
            infowindow.open(map, marker);
        }

        function updateMapInfoWindow(latestData) {
            const content = `
                <h3>Nhà Khách KTX ĐHQG Hòa Lạc</h3>
                <p><strong>Ngày:</strong> ${latestData.date || 'Không có dữ liệu'}</p>
                <p><strong>Giờ:</strong> ${latestData.time || 'Không có dữ liệu'}</p>
                <p><strong>Nhiệt độ:</strong> ${latestData.temperature || 0} °C</p>
                <p><strong>Độ ẩm:</strong> ${latestData.humidity || 0} %</p>
                <p><strong>CO:</strong> ${latestData.co || 0} ppm</p>
                <p><strong>PM2.5:</strong> ${latestData.pm25 || 0} µg/m³</p>
                <p><strong>PM10:</strong> ${latestData.pm10 || 0} µg/m³</p>
                <p><strong>CO₂:</strong> ${latestData.co2 || 0} ppm</p>
            `;
            infowindow.setContent(content);
            marker.setIcon(getMarkerIcon(latestData.pm25 || 0));
            infowindow.open(map, marker);
        }

        function getMarkerIcon(pm25) {
            const baseIconSize = new google.maps.Size(20, 20); // Giảm kích thước xuống 20x20 pixel
            if (pm25 <= 12) {
                return {
                    url: 'img/t.png', // Icon xanh
                    scaledSize: baseIconSize
                };
            } else if (pm25 <= 35) {
                return {
                    url: 'https://maps.google.com/mapfiles/ms/icons/yellow-dot.png', // Icon vàng
                    scaledSize: baseIconSize
                };
            } else if (pm25 <= 55) {
                return {
                    url: 'https://maps.google.com/mapfiles/ms/icons/orange-dot.png', // Icon cam
                    scaledSize: baseIconSize
                };
            } else {
                return {
                    url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png', // Icon đỏ
                    scaledSize: baseIconSize
                };
            }
        }
        function updateChart(recentData) {
            const labels = recentData.map(row => {
                const date = new Date(row[0]); // Sử dụng cột Ngay_gio (A)
                return date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' }); // Hiển thị giờ:phút
            });
            const temperatureData = recentData.map(row => parseFloat(row[1] || 0)); // Nhiệt độ (B)
            const humidityData = recentData.map(row => parseFloat(row[2] || 0));    // Độ ẩm (C)
            const coData = recentData.map(row => parseFloat(row[3] || 0));          // CO (D)
            const pm25Data = recentData.map(row => parseFloat(row[4] || 0));        // PM2.5 (E)
        
            if (!environmentChart) {
                const ctx = document.getElementById('environmentChart').getContext('2d');
                environmentChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Nhiệt độ (°C)',
                                data: temperatureData,
                                borderColor: 'rgba(255, 99, 132, 1)',
                                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                fill: true,
                            },
                            {
                                label: 'Độ ẩm (%)',
                                data: humidityData,
                                borderColor: 'rgba(54, 162, 235, 1)',
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                fill: true,
                            },
                            {
                                label: 'CO (ppm)',
                                data: coData,
                                borderColor: 'rgba(255, 206, 86, 1)',
                                backgroundColor: 'rgba(255, 206, 86, 0.2)',
                                fill: true,
                            },
                            {
                                label: 'PM2.5 (µg/m³)',
                                data: pm25Data,
                                borderColor: 'rgba(75, 192, 192, 1)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                fill: true,
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Biểu đồ chất lượng không khí',
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: 'Thời gian'
                                }
                            },
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: 'Giá trị'
                                }
                            }
                        }
                    }
                });
            } else {
                environmentChart.data.labels = labels;
                environmentChart.data.datasets[0].data = temperatureData;
                environmentChart.data.datasets[1].data = humidityData;
                environmentChart.data.datasets[2].data = coData;
                environmentChart.data.datasets[3].data = pm25Data;
                environmentChart.update();
            }
        }
        async function fetchData() {
            const sheetName = 'Sheet1';
            const range = `${sheetName}!A:G`; // Lấy cột A-G (Ngay_gio, T, H, CO, P25, P10, CO2)
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${encodeURIComponent(range)}?key=${apiKey}`;
            try {
                const res = await fetch(url);
                const json = await res.json();
                if (json.values && json.values.length) {
                    const lastRow = json.values[json.values.length - 1];
                    displayData(lastRow);
                    updateChart(json.values.slice(-20));
                    const md = {
                        date: lastRow[0] ? new Date(lastRow[0]).toLocaleDateString('vi-VN') : 'Không có dữ liệu',
                        time: lastRow[0] ? new Date(lastRow[0]).toLocaleTimeString('vi-VN') : 'Không có dữ liệu',
                        temperature: lastRow[1] || 0,
                        humidity: lastRow[2] || 0,
                        co: lastRow[3] || 0,
                        pm25: lastRow[4] || 0,
                        pm10: lastRow[5] || 0,
                        co2: lastRow[6] || 0
                    };
                    updateMapInfoWindow(md);
                }
            } catch (err) {
                console.error('Error fetching data:', err);
            }
        }

        const sheetId = '1oOeN-HUb_xZfcIiY0d06MXUGL0-vsJW5r-zNa_NIKe4';
        const apiKey = 'AIzaSyAFLByP7yNm_HMSO8sTyWjAXxwVrcXNoXw';

        fetchData(); 
        setInterval(fetchData, 30000); 
        window.addEventListener('DOMContentLoaded', (event) => {
            const alertModal = new bootstrap.Modal(document.getElementById('alertModal'));
            alertModal.show();
        });

    </script>
    <div class="modal fade" id="alertModal" tabindex="-1" aria-labelledby="alertModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="alertModalLabel" data-translate="latestDataTitle">THÔNG TIN DỮ LIỆU MỚI NHẤT</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-bordered">
                        <thead>
                          <tr>
                            <th scope="col">STT</th>
                            <th scope="col" data-translate="location">Vị trí</th>
                            <th scope="col" data-translate="date">Ngày</th>
                            <th scope="col" data-translate="time">Giờ</th>
                            <th scope="col" data-translate="temperature">Nhiệt độ</th>
                            <th scope="col" data-translate="humidity">Độ ẩm</th>
                            <th scope="col" data-translate="co">CO</th>
                            <th scope="col" data-translate="pm25">PM2.5</th>
                            <th scope="col">PM10</th>
                            <th scope="col">CO₂</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr>
                            <td>1</td>
                            <td id="latestLocation">ĐHQG HN</td>
                            <td id="latestDate">Đang tải...</td>
                            <td id="latestTime">Đang tải...</td>
                            <td id="latestTemperature">Đang tải...</td>
                            <td id="latestHumidity">Đang tải...</td>
                            <td id="latestCO">Đang tải...</td>
                            <td id="latestPM25">Đang tải...</td>
                            <td id="latestPM10">Đang tải...</td>
                            <td id="latestCO2">Đang tải...</td>
                          </tr>
                        </tbody>
                    </table>
                    <h5 class="mt-4" data-translate="pollutionLevelsTitle">Các cấp độ ô nhiễm không khí</h5>
                    <table class="table">
                        <thead>
                            <tr>
                                <th scope="col" data-translate="pollutionAmount">Hàm lượng</th>
                                <th scope="col" data-translate="pollutionLevel">Cấp độ</th>
                                <th scope="col" data-translate="pollutionQuality">Chất lượng không khí</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="table-success">
                                <td> 12 trở xuống </td>
                                <td>1</td>
                                <td data-translate="qualityGood">Tốt</td>
                            </tr>
                            <tr class="table-warning">
                                <td>13-35</td>
                                <td>2</td>
                                <td data-translate="qualityModerate">Vừa phải</td>
                            </tr>
                            <tr class="table-danger">
                                <td>36-55</td>
                                <td>3</td>
                                <td data-translate="qualityUnhealthy">Kém</td>
                            </tr>
                            <tr class="table-dark">
                                <td>56 trở lên</td>
                                <td>4</td>
                                <td data-translate="qualityVeryUnhealthy">Rất kém</td>
                            </tr>
                        </tbody>
                    </table>
                    <p class="text-danger mt-3" data-translate="note">
                        Chú ý: Dữ liệu dựa trên sản phẩm thử nghiệm TLD 66 của nhóm sinh viên Khoa Địa Chất, Trường ĐH KHTN - ĐHQG HN
                        KHÔNG THAY THẾ CHO CÁC THÔNG SỐ CHÍNH THỨC CỦA CƠ QUAN NHÀ NƯỚC VỀ ĐÁNH GIÁ CHẤT LƯỢNG KHÔNG KHÍ 
                    </p>                    
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="dismissModal()">Đóng</button>
                </div>
            </div>
        </div>
    </div>
    <section id="chart-section" class="chart-section-padding">
        <div class="row mt-4">
            <div class="col-lg-8">
                <h5 class="text-center" data-translate="chartSectionTitle">Biểu đồ giám sát chất lượng không khí</h5>
                <canvas id="environmentChart"></canvas>
        </div>
            <div class="col-lg-4 d-flex justify-content-between cards-container">
                <div id="card1" class="card1 text-white text-center bg-success">
                    <div class="card-body">
                        <div class="img-area mb-4">
                            <img src="img/khoadiachat.jpg" alt="" class="img-fluid">
                        </div>
                        <h3 class="card-title" data-translate="webUsageGuideTitle">Tài liệu sử dụng web</h3>
                        <a class="text-white" href="tailieu/huongdan1.pdf" target="_blank">Tài liệu hướng dẫn sử dụng</a>
                    </div>
                </div>
                <div id="card2" class="card1 text-white text-center bg-success">
                    <div class="card-body">
                        <div class="img-area mb-4">
                            <img src="img/khoadiachat.jpg" alt="" class="img-fluid">
                        </div>
                        <h3 class="card-title" data-translate="codeDocumentTitle">Tài liệu mã code</h3>
                        <a class="text-white" href="#" target="_blank">Xem chi tiết tại đây</a>
                    </div>
                </div>
                <div id="card3" class="card1 text-white text-center bg-success">
                    <div class="card-body">
                        <div class="img-area mb-4">
                            <img src="img/khoadiachat.jpg" alt="" class="img-fluid">
                        </div>
                        <h3 class="card-title" data-translate="researchTitle">Nghiên cứu</h3>
                        <a class="text-white" href="#" target="_blank">Xem chi tiết tại đây</a>
                    </div>
                </div>
            </div>  
                        <div class="row mt-4">
                <div class="col-lg-12">
                    <h5 class="text-center">Thông tin dữ liệu thời tiết</h5>
                    <div class="weather-container p-3 bg-light rounded mx-auto" style="max-width: 800px;">
                        <input type="text" id="city-input" class="form-control mb-3" placeholder="Enter city name (e.g., Hanoi)">
                        <button class="btn btn-primary w-100" onclick="getWeatherForCity()">Tìm kiếm</button>
                        <div id="weather-display" class="mt-3"></div>
                        <div id="forecast-display" class="mt-3"></div> 
                        <p id="error-message" class="text-danger"></p>
                        <p>Nguồn: OpenWeatherMap</p>
                    </div>
                </div>
            </div>
            <script>
                const apiKey1 = '12118cdb333f0039947273d009989237';
            async function getWeather(city = null, lat = 20.99567, lon = 105.80676) {
                const weatherDisplay = document.getElementById('weather-display');
                const forecastDisplay = document.getElementById('forecast-display');
                const errorMessage = document.getElementById('error-message');

                weatherDisplay.innerHTML = '';
                forecastDisplay.innerHTML = '';
                errorMessage.textContent = '';

                let weatherApiUrl, forecastApiUrl;

                if (city) {
                    weatherApiUrl = `https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${apiKey1}&units=metric`;
                    forecastApiUrl = `https://api.openweathermap.org/data/2.5/forecast?q=${city}&appid=${apiKey1}&units=metric`;
                } else {
                    weatherApiUrl = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${apiKey1}&units=metric`;
                    forecastApiUrl = `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${apiKey1}&units=metric`;
                }

                try {
                    const weatherResponse = await fetch(weatherApiUrl);
                    const weatherData = await weatherResponse.json();

                    if (weatherData.cod !== 200) {
                        errorMessage.textContent = `Error: ${weatherData.message}`;
                        return;
                    }

                    const weatherHtml = `
                        <p><strong>Vị trí:</strong> ${weatherData.name}</p>
                        <p><strong>Nhiệt độ :</strong> ${weatherData.main.temp} °C</p>
                        <p><strong>Thời tiết:</strong> ${weatherData.weather[0].description}</p>
                        <p><strong>Độ ẩm:</strong> ${weatherData.main.humidity}%</p>
                        <p><strong>Tốc độ gió:</strong> ${weatherData.wind.speed} m/s</p>
                    `;

                    weatherDisplay.innerHTML = weatherHtml;
                    const forecastResponse = await fetch(forecastApiUrl);
                    const forecastData = await forecastResponse.json();
                    displayForecast(forecastData);

                } catch (error) {
                    console.error('Error fetching weather data:', error);
                    errorMessage.textContent = 'Failed to fetch weather data. Please try again later.';
                }
            }
            function displayForecast(data) {
                const forecastDisplay = document.getElementById('forecast-display');
                let forecastHtml = '<h5>Dự báo thời tiết trong 5 ngày:</h5>';
                const days = {};
                data.list.forEach(item => {
                    const date = new Date(item.dt_txt).toLocaleDateString('vi-VN', { weekday: 'short', day: 'numeric', month: 'numeric' });
                    const time = new Date(item.dt_txt).getHours();

                    if (time === 12 && !days[date]) {
                        days[date] = `
                            <div class="forecast-card">
                                <h6>${date}</h6>
                                <img src="http://openweathermap.org/img/wn/${item.weather[0].icon}@2x.png" alt="${item.weather[0].description}" />
                                <p><strong>${item.main.temp} °C</strong></p>
                                <p>${item.weather[0].description}</p>
                                <p>Độ ẩm: ${item.main.humidity}%</p>
                            </div>
                        `;
                    }
                });

                forecastHtml += Object.values(days).join('');
                forecastDisplay.innerHTML = forecastHtml;
            }
            document.addEventListener('DOMContentLoaded', function() {
                getWeather();
            });

            function getWeatherForCity() {
                const city = document.getElementById('city-input').value;
                getWeather(city);
            }
            </script>
        <div class="row mt-4">
            <!-- Cảm biến nhiệt độ & độ ẩm - DHT22 -->
            <div class="sensor-item">
                <div class="d-flex">
                    <img src="img/dht22.jpg" alt="DHT22 Sensor" class="img-fluid me-3" style="width: 100px; height: auto;">
                    <div>
                        <h5 class="text-start" data-translate="aboutHeader">Cảm biến nhiệt độ & độ ẩm - DHT22</h5>
                        <p data-translate="dht22Description">
                            Cảm biến độ ẩm và nhiệt độ DHT22 sử dụng giao tiếp 1 Wire dễ dàng kết nối với Vi điều khiển để thực hiện các ứng dụng đo nhiệt độ, độ ẩm môi trường, cảm biến có chất lượng tốt, kích thước nhỏ gọn, độ bền và độ ổn định cao.
                            <a href="tailieu/dht_document (1).pdf" target="_blank" data-translate="dht22LinkText">xem chi tiết tại đây</a>
                        </p>
                    </div>
                </div>
            </div>
        
            <!-- Cảm biến hàm lượng khí CO - MQ-7 -->
            <div class="sensor-item">
                <div class="d-flex">
                    <img src="img/MQ-7.jpg" alt="MQ-7 Sensor" class="img-fluid me-3" style="width: 100px; height: auto;">
                    <div>
                        <h5 class="text-start" data-translate="coSensorHeader">Cảm biến hàm lượng khí CO - MQ-7</h5>
                        <p data-translate="coSensorDescription">
                            Cảm biến khí CO MQ-7 là cảm biến bán dẫn giá rẻ có khả năng phát hiện khí carbon monoxide từ 10 đến 1000 ppm. Vật liệu tạo ra cảm biến là từ SnO2, có độ dẫn điện thấp trong không khí sạch.
                            <a href="https://www.instructables.com/Arduino-CO-Monitor-Using-MQ-7-Sensor/" target="_blank" data-translate="coSensorLinkText">xem chi tiết tại đây</a>
                        </p>
                    </div>
                </div>
            </div>
        
            <!-- Cảm biến đo chất lượng khí - Nova PM SDS011 -->
            <div class="sensor-item">
                <div class="d-flex">
                    <img src="img/sds011.jpg" alt="SDS011 Sensor" class="img-fluid me-3" style="width: 100px; height: auto;">
                    <div>
                        <h5 class="text-start" data-translate="airQualitySensorHeader">Cảm biến đo chất lượng khí - Nova PM SDS011</h5>
                        <p data-translate="sds011Description">
                            SDS011 là cảm biến đo chất lượng không khí có thể phát hiện các hạt bụi và nồng độ khói trong không khí. Chính xác hơn, nó có thể đo nồng độ các hạt bụi có kích thước từ 0.3 đến 10um.
                            <a href="SDS011-DATASHEET.pdf" target="_blank" data-translate="sds011LinkText">xem chi tiết tại đây</a>
                        </p>
                    </div>
                </div>
            </div>
        
            <!-- Cảm biến đo hàm lượng bụi mịn - SHARP GP2Y1010AU0F -->
            <div class="sensor-item">
                <div class="d-flex">
                    <img src="img/sharp.jpg" alt="SHARP GP2Y1010AU0F Sensor" class="img-fluid me-3" style="width: 100px; height: auto;">
                    <div>
                        <h5 class="text-start" data-translate="fineDustSensorHeader">Cảm biến đo hàm lượng bụi mịn - SHARP GP2Y1010AU0F</h5>
                        <p data-translate="sharpDustSensorDescription">
                            Cảm biến dùng để nhận biết nồng độ bụi trong không khí. Nguyên lý hoạt động dựa trên led phát hồng ngoại trong cảm biến, khi có bụi vào sẽ bị khúc xạ, làm giảm cường độ tia hồng ngoại dẫn đến điện áp thay đổi.
                            <a href="tailieu/gp2y1010au_e.pdf" target="_blank" data-translate="sharpDustSensorLinkText">xem chi tiết tại đây</a>
                        </p>
                    </div>
                </div>
            </div>
        </div>        
        <!-- Research Team Section -->
        <section id="services" class="services team-section-padding mt-4">
            <div class="container">
                <div class="row">
                    <div class="col-md-12">
                        <div class="section-header text-center pb-5">
                            <h1 data-translate="teamSectionTitle">Nhóm nghiên cứu gồm:</h1>
                            <p data-translate="teamMembersSubtitle">Các thành viên chính</p>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <img src="img/VD.jpg" alt="" class="img-fluid rounded-circle">
                                <h2 class="card-title py-2"><span class="text-success" data-translate="member1Name">Thái Văn Đức</span></h2>
                                <p class="card-text">Lớp: K66 CNQT & GSTNMT</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <img src="img/KL.jpg" alt="" class="img-fluid rounded-circle">
                                <h2 class="card-title py-2"><span class="text-success" data-translate="member2Name">Nguyễn Khánh Linh</span></h2>
                                <p class="card-text">Lớp: K66 CNQT & GSTNMT</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-md-4">
                        <div class="card text-center">
                            <div class="card-body text-center">
                                <img src="img/GT1.jpg" alt="" class="img-fluid rounded-circle mb-2" style="width: 175px; height: 175px; object-fit: cover;">
                                <h2 class="card-title py-2 text-success" data-translate="member3Name">Giang Ngọc Thảo</h2>
                                <p class="card-text">Lớp: K66 CNQT & GSTNMT</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
    
    <!-- Footer -->
    <footer class="mt-4">
        <div class="items-infor d-flex justify-content-center">
            <div class="infor-wrap">
                <h3 data-translate="contactInfo">Thông tin hỗ trợ</h3>
                <div class="color_infor-wrap">
                    <ul>
                        <li>
                            <span data-translate="phone">Số điện thoại: </span>
                            <span>
                                (+84) 935548502
                                <br>
                                Thái Văn Đức
                            </span>
                        </li>
                        <li>
                            <span data-translate="email">Email: </span>
                            <span>thaivanduc_t66@hus.edu.vn</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script> 
</body>
</html>
