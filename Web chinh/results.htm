<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K66 Công nghệ quan trắc</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        #data-container .card {
            margin-bottom: 20px;
        }
        #chart-container {
            margin-top: 50px;
        }
        canvas {
            max-width: 100%;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <a class="navbar-brand" href="#"><span class="text-success">K66</span>CNQT</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link" href="#">Trang chủ</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">Thông số thời gian thực</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">Trích suất kết quả đo</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">Góp ý & nhận xét</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#loginModal">Đăng nhập</a>
                </li>
            </ul>
        </div>
    </nav>

    <div class="modal fade" id="alertModal" tabindex="-1" aria-labelledby="alertModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="alertModalLabel">Dữ liệu mới nhất</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="latestData">Đang tải dữ liệu...</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>

    <section id="data-section" class="data-section-padding">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <div class="section-header text-center pb-5">
                        <h1>Dữ liệu từ Google Sheets</h1>
                        <p>Thông tin được cập nhật từ bảng tính Google Sheets</p>
                    </div>
                </div>
            </div>
            <div id="data-container" class="row">

            </div>
        </div>
    </section>

    <section id="chart-section" class="chart-section-padding">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <div class="section-header text-center pb-5">
                        <h1>Biểu đồ giám sát chất lượng không khí</h1>
                    </div>
                </div>
                <div id="chart-container" class="col-md-12">
                    <canvas id="environmentChart"></canvas>
                </div>
            </div>
        </div>
    </section>

    <footer>
        <div class="items-infor d-flex">
            <div class="infor-wrap">
                <h3>Thông tin hỗ trợ</h3>
                <div class="color_infor-wrap"> 
                    <ul>
                        <li>
                            Số điện thoại: 
                                <span>
                                    (+84) 935548502
                                    <br>
                                    Thái Văn Đức
                                </span>
                        </li>
                        <li>
                            Email: <span>thaivanduc_t66@hus.edu.vn</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
  
        const sheetId = '1oOeN-HUb_xZfcIiY0d06MXUGL0-vsJW5r-zNa_NIKe4';


        const apiKey = 'AIzaSyAFLByP7yNm_HMSO8sTyWjAXxwVrcXNoXw'; // Thay YOUR_API_KEY bằng API Key của bạn

        const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/sheet_id?key=${apiKey}`;

        let environmentChart;
        async function fetchData() {
            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data && data.values) {
                    // Hiển thị dữ liệu trên trang web
                    const container = document.getElementById('data-container');
                    container.innerHTML = '';  

                    const lastRow = data.values[data.values.length - 1];  
                    const rowData = document.createElement('div');
                    rowData.classList.add('col-md-4');
                    rowData.innerHTML = `
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title">Thông tin chất lượng môi trường không khí ở trường tui</h5>
                                <p class="card-text">Ngày: ${lastRow[0]}</p>
                                <p class="card-text">Giờ: ${lastRow[1]}</p>
                                <p class="card-text">Nhiệt độ: ${lastRow[2]}</p>
                                <p class="card-text">Độ ẩm: ${lastRow[3]}</p>
                                <p class="card-text">CO: ${lastRow[4]}</p>
                                <p class="card-text">PM2.5: ${lastRow[5]}</p>
                            </div>
                        </div>
                    `;
                    container.appendChild(rowData);

                    const recentData = data.values.slice(-20);

                    updateChart(recentData);

                    updateModal(lastRow);
                }
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        function updateChart(recentData) {
            const labels = recentData.map(row => row[1]);  
            const temperatureData = recentData.map(row => parseFloat(row[2] || 0));  // Nhiệt độ
            const humidityData = recentData.map(row => parseFloat(row[3] || 0));  // Độ ẩm
            const coData = recentData.map(row => parseFloat(row[4] || 0));  // CO
            const pm25Data = recentData.map(row => parseFloat(row[5] || 0));  // PM2.5

            if (!environmentChart) {
                const ctx = document.getElementById('environmentChart').getContext('2d');
                environmentChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Nhiệt độ (°C)',
                                data: temperatureData,
                                borderColor: 'rgba(255, 99, 132, 1)',
                                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                fill: true,
                            },
                            {
                                label: 'Độ ẩm (%)',
                                data: humidityData,
                                borderColor: 'rgba(54, 162, 235, 1)',
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                fill: true,
                            },
                            {
                                label: 'CO (ppm)',
                                data: coData,
                                borderColor: 'rgba(255, 206, 86, 1)',
                                backgroundColor: 'rgba(255, 206, 86, 0.2)',
                                fill: true,
                            },
                            {
                                label: 'PM2.5 (µg/m³)',
                                data: pm25Data,
                                borderColor: 'rgba(75, 192, 192, 1)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                fill: true,
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Biểu đồ chất lượng không khí nơi các bạn'
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: 'Giờ'
                                }
                            },
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: 'Giá trị'
                                }
                            }
                        }
                    }
                });
            } else {
                environmentChart.data.labels = labels;
                environmentChart.data.datasets[0].data = temperatureData;
                environmentChart.data.datasets[1].data = humidityData;
                environmentChart.data.datasets[2].data = coData;
                environmentChart.data.datasets[3].data = pm25Data;
                environmentChart.update();  // Cập nhật biểu đồ
            }
        }

        function updateModal(latestData) {
            const modalContent = `
                <p><strong>Ngày:</strong> ${latestData[0]}</p>
                <p><strong>Giờ:</strong> ${latestData[1]}</p>
                <p><strong>Nhiệt độ:</strong> ${latestData[2]}°C</p>
                <p><strong>Độ ẩm:</strong> ${latestData[3]}%</p>
                <p><strong>CO:</strong> ${latestData[4]} ppm</p>
                <p><strong>PM2.5:</strong> ${latestData[5]} µg/m³</p>
            `;
            document.getElementById('latestData').innerHTML = modalContent;

            const alertModal = new bootstrap.Modal(document.getElementById('alertModal'));
            alertModal.show();
        }

        fetchData();
        setInterval(fetchData, 60000); 
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>
